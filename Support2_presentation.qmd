---
title: "EXAM"
author: "Mariateresa Russo e Angelo Capasso"
format:
  revealjs:
    theme: solarized
    highlight: pygments
    center: true
    transition: fade
    background-transition: slide
    slide-number: true
    preview-links: true
    code-fold: true
    code-summary: "code"
---

```{r setup, include = FALSE, echo = FALSE}
library(tidymodels)
library(tidyverse)
library(GGally)
library(ggplot2)
library(FactoMineR)
library(factoextra)
library(Rdimtools)
library(readr)
library(janitor)
library(knitr)
library(patchwork)
library(gridExtra)
library(lattice)
library(plotly)
library(clustrd)
library(mclust)
library(cluster)
library(VIM)
library(rpart)
library(kknn)
library(dplyr)
library(tidyr)
library(purrr)
library(rattle)
library(iml)
```

```{r, echo = FALSE, warning=FALSE, include=FALSE}
support2 <- read_csv("support2.csv")

data = support2
```

```{r, echo = FALSE, warning=FALSE, include=FALSE}
colnames(data) <- c("id", "age", "death", "sex", "hospdead", "slos", "d.time", "dzgroup", "dzclass", "num.co", "edu", "income", "scoma", "charges", "totcst", "totmcst", "avtisst", "race", "sps", "aps", "surv2m", "surv6m", "hday", "diabetes", "dementia", "ca", "prg2m", "prg6m", "dnr", "dnrday", "meanbp", "wblc", "hrt", "resp", "temp", "pafi", "alb", "bili", "crea", "sod", "ph", "glucose", "bun", "urine", "adlp", "adls", "sfdm2")

data = data |>
  mutate(
    across(c(where(is.character), death, hospdead, 
                  diabetes, income, dementia), ~ factor(.x))
  ) |> 
  select(-c(id, scoma, sps, surv2m, surv6m, sfdm2))
```

# 1) Dataset

## Numerical Features

::: {style="font-size: 37%;"}
-   **age**: age  
-   **slos**: length of hospital stay (days)  
-   **d.time**: follow-up time (days) 
-   **hday**: number of hospital days up to the clinical event (discharge or death)
-   **num.co**: number of comorbidities  
-   **edu**: years of education  
-   **charges**: charges billed to the patient  
-   **totcst**: cost estimated by the RCC index  
-   **totmcst**: actual cost billed considering bonuses  
-   **avtisst**: Therapeutic Intervention Scoring System (intensity of care)  
-   **aps**: Acute Physiology Score (vital conditions assessment)  
-   **meanbp**: mean blood pressure  
-   **wblc**: white blood cell count  
-   **hrt**: heart rate  
-   **resp**: respiratory rate  
-   **temp**: body temperature  
-   **pafi**: PaO2/FiO2 ratio  
-   **alb**: albumin  
-   **bili**: bilirubin  
-   **crea**: creatinine  
-   **sod**: sodium  
-   **ph**: blood pH  
-   **glucose**, **bun**, **urine**  
-   **adlp**, **adls**: scores indicating daily living activities  
-   **dnrday**: day of the DNR (do-not-resuscitate) decision  
-   **prg2m**, **prg6m**: survival probability at 2 and 6 months  
:::

## Categorical Features

::: {style="font-size: 60%;"}
-   **death**: 0 = alive, 1 = deceased  
-   **sex**: male / female  
-   **hospdead**: death in hospital (0/1)  
-   **diabetes**, **dementia**: presence/absence  
-   **dzgroup**: diagnostic group (e.g., Lung Cancer, Cirrhosis, ARF/MOSF)  
-   **dzclass**: broader diagnostic class  
-   **income**: income category  
-   **race**: white, black, other  
-   **ca**: cancer category (none / local / metastatic)  
-   **dnr**: DNR status (do-not-resuscitate)  
-   **sfdm2**: functional status at 2 months 
:::

# 2) Esplorative Data Analysis

## Missing values

```{r}
#| echo: true
#| code-fold: true
#| code-summary: "code"
missing_summary <- tibble(
  variabile = names(data),
  n_na      = colSums(is.na(data)),
  perc_na   = colMeans(is.na(data)) * 100
) |>
  filter(n_na > 0) |>         
  arrange(desc(perc_na))

ggplot(missing_summary, aes(x = reorder(variabile, perc_na), y = perc_na)) +
  geom_col(fill = "#8FD4B8") +
  coord_flip() +
  labs(title = "Features with missing values",
       x = "Feature", y = "% NA")
```

## Numerical Features

### Correlation matrix

```{r}
#| echo: true
#| code-fold: true
#| code-summary: "code"
num_data <- data[, sapply(data, is.numeric)]

corr_mat <- cor(num_data, use = "pairwise.complete.obs")

levelplot(
  corr_mat,
  scales = list(x = list(rot = 45)),
  xlab = " ",
  ylab = " ",
  main = "Correlation Heatmap",
  col.regions = colorRampPalette(c("#2A5783", "white", "#F07F28"))(100)
)
```

------------------------------------------------------------------------

### Hierarchical Clustering

```{r}
#| echo: true
#| code-fold: true
#| code-summary: "code"
dist_mat <- as.dist(1 - corr_mat)

hc <- hclust(dist_mat, method = "complete")

plot(hc, main = "Hierarchical Clustering")
```

## Categorical Features

```{r, warning=FALSE}
#| echo: true
#| code-fold: true
#| code-summary: "code"
data %>%
  select(where(is.factor)) %>%
  pivot_longer(cols = everything(), names_to = "variabile", values_to = "valore") %>%
  ggplot(aes(x = valore, y = ..prop.., group = 1, fill = valor)) +
  geom_bar(fill = "#8FD4B8") +
  facet_wrap(~ variabile, scales = "free") +
  scale_y_continuous(labels = scales::percent_format()) +
  labs(title = "Categorical Features-frequency distribution",
       x = "Category", y = "Percentage") +
  theme_minimal(base_size = 12) +
  theme(axis.text.x = element_text(angle = 45, hjust = 1),
        legend.position = "none",
        strip.text = element_text(size = 10))

```

## Manage Missing Values

::: {style="font-size: 50%;"}
-Remove features with more than 30% NA: bun, urine, glucose, adlp

```{r}
data <- data |> select(-c(
  adlp, urine, glucose, bun, totmcst, alb, adls, bili, pafi, ph,
  prg2m, edu, prg6m, totcst))
```

-Remove features correlated with other features: avtisst, dnrday

```{r}
data <- data |> 
  select(-c(avtisst, dnrday))
# adls adlp
# totmcst totcst charges
# aps avtisst
# dnrday slos
```

-Imputation for other features: income, wblc, charges, crea, race, dnr
```{r}
#| echo: true
#| code-fold: true
#| code-summary: "code"
#| 
data <- data |>
  mutate(income = fct_explicit_na(income, na_level = "nd"))

library(VIM)
set.seed(6)
data_imp <- kNN(data, variable = c("wblc","charges","crea","race","dnr"), k = 5)
data_imp <- data_imp |> 
  select(-c(wblc_imp, charges_imp, crea_imp, race_imp, dnr_imp))
```
:::

# 3) Model 1: MCA + Kmeans

```{r,echo=FALSE,include=FALSE}
data_scaled = data |> 
  mutate(across(
    where(is.numeric),
    ~ as.numeric(scale(.x))
  ))

data_scaled <- data_scaled |> 
  na.omit() 
```

Application of MCA on the 3 most important numerical features (encoded) and on the most relevant categorical features

## Fuzzy Encoding
::: {style="font-size: 50%;"}
```{r}
#| echo: true
#| code-fold: true
#| code-summary: "code"

num_vars <- data_scaled |> select(meanbp, hrt, temp)

stats <- num_vars |> summarise(across(everything(), list(min=min, med=median, max=max))) |> as.list()
fuzzy_encoded <- num_vars |> mutate(
  meanbp_low  = pmax(0, (stats$meanbp_med - meanbp)/(stats$meanbp_med - stats$meanbp_min)),
  meanbp_mid  = pmax(0, 1 - abs(meanbp - stats$meanbp_med)/(stats$meanbp_max - stats$meanbp_min)),
  meanbp_high = pmax(0, (meanbp - stats$meanbp_med)/(stats$meanbp_max - stats$meanbp_med)),
  
  hrt_low  = pmax(0, (stats$hrt_med - hrt)/(stats$hrt_med - stats$hrt_min)),
  hrt_mid  = pmax(0, 1 - abs(hrt - stats$hrt_med)/(stats$hrt_max - stats$hrt_min)),
  hrt_high = pmax(0, (hrt - stats$hrt_med)/(stats$hrt_max - stats$hrt_med)),
  
  temp_low  = pmax(0, (stats$temp_med - temp)/(stats$temp_med - stats$temp_min)),
  temp_mid  = pmax(0, 1 - abs(temp - stats$temp_med)/(stats$temp_max - stats$temp_min)),
  temp_high = pmax(0, (temp - stats$temp_med)/(stats$temp_max - stats$temp_med))
) |> 
  select(-c(meanbp, temp, hrt))

meanbp_cat <- factor(c("low","mid","high")[max.col(fuzzy_encoded[,c("meanbp_low","meanbp_mid","meanbp_high")])])
hrt_cat    <- factor(c("low","mid","high")[max.col(fuzzy_encoded[,c("hrt_low","hrt_mid","hrt_high")])])
temp_cat   <- factor(c("low","mid","high")[max.col(fuzzy_encoded[,c("temp_low","temp_mid","temp_high")])])

categorical_vars <- data_scaled |> select_if(is.factor)
categorical_vars_ext <- categorical_vars |> 
  mutate(meanbp_cat = meanbp_cat,
         hrt_cat    = hrt_cat,
         temp_cat   = temp_cat) |> 
  select(-income)   # se vuoi escludere income

categorical_vars_ext
```
:::

## MCA
```{r}
#| echo: true
#| code-fold: true
#| code-summary: "code"

res.mca_vars <- MCA(categorical_vars_ext, graph = FALSE)
fviz_mca_var(res.mca_vars, repel = TRUE) 

```

## Kmeans
```{r}
#| echo: true
#| code-fold: true
#| code-summary: "code"

coords_mca <- res.mca_vars$ind$coord[,c(1,3)]
fviz_nbclust(coords_mca, kmeans, method = "silhouette")
```

## Kmeans results
```{r}
set.seed(6)
res.mca_kmeans <- kmeans(coords_mca, centers = 4, nstart = 25)
fviz_cluster(res.mca_kmeans, data = coords_mca,
             geom = "point",
             labelsize = 4,
             main = "K-means + MCA")
```

# Evaluation of Results

## Surrogate Model
```{r}
#| echo: true
#| code-fold: true
#| code-summary: "code"

sur_mod_dataframe <- data.frame(
  cluster = res.mca_kmeans$cluster,
  income = categorical_vars$income,
  slos = data_scaled$slos,
  sod = data_scaled$sod,
  n_comorbidity = data_scaled$num.co,
  charges = data_scaled$charges, 
  wblc = data_scaled$wblc,
  age = data_scaled$age,
  d.time = data_scaled$d.time,
  resp = data_scaled$resp,
  crea = data_scaled$crea
)

surrogate_model <- rpart(
  cluster ~ .,
  data = sur_mod_dataframe,
  method = "class",
  control = rpart.control(
    minsplit = 250,   # più basso → più scissioni
    cp = 0.01,       # meno penalizzazione → più variabili entrano
    maxdepth = 30    # albero più profondo
  )
)

fancyRpartPlot(surrogate_model)
```

## ----Were NA missing at random?
```{r}
#| echo: true
#| code-fold: true
#| code-summary: "code"

```

## ----Cluster Evaluation
```{r}
#| echo: true
#| code-fold: true
#| code-summary: "code"

```










# 4) Model 2: SVM

```{r,echo=FALSE,include=FALSE}
tot_data = data_imp
head(tot_data)

tot_data_scaled = tot_data |> 
  mutate(across(
    where(is.numeric),
    ~ as.numeric(scale(.x)))) |> 
  drop_na()
```

## The target variable
```{r}
ggplot(tot_data, aes(x = death, y = ..prop.., group = 1)) +
  geom_bar(fill = "#8FD4B8", color = "grey30") +
  scale_y_continuous(labels = scales::percent_format()) +
  labs(
    title = "'death' Frequency",
    x = "Death",
    y = "Percentage"
  ) +
  theme_minimal(base_size = 14)

# balance the class?
```

## SVM Model
::: {style="font-size: 50%;"}
- Train Test split
```{r}
#| echo: true
#| code-fold: true
#| code-summary: "code"

set.seed(6)

split <- initial_split(tot_data_scaled, prop = 0.8, strata = death)
train <- training(split)
test  <- testing(split)

folds <- vfold_cv(train, v = 10, strata = death)
```

- Recipe and Workflow
```{r}
#| echo: true
#| code-fold: true
#| code-summary: "code"

svm_rec <- recipe(death ~ ., data = train) |>                     # 
  step_dummy(all_nominal_predictors())           # dummy encodin                            
svm_spec <- svm_rbf(
  mode = "classification",
  cost = tune(),            # penalty sugli errori
  rbf_sigma = tune()        # parametro kernel RBF
) |> 
  set_engine("kernlab")

# Workflow
svm_wf <- workflow() |>
  add_model(svm_spec) |>
  add_recipe(svm_rec)
```

- Tuning parameters: cost and complexity(rbf_sigma)
```{r}
#| echo: true
#| code-fold: true
#| code-summary: "code"

set.seed(6)

svm_grid <- tibble(
  cost = c(0.1, 1, 10, 100),
  rbf_sigma = c(0.001, 0.01, 0.1, 1)
)

# Step 1: gridsearch
#svm_grid_res <- tune_grid(svm_wf, resamples = folds, grid = svm_grid, metrics = metric_set(roc_auc))

# Step 2: bayesian tuning
#svm_bayes <- tune_bayes(svm_wf, resamples = folds, metrics = metric_set(roc_auc), initial = svm_grid_res, iter = 3, control = control_bayes(verbose = TRUE))

# Best params
best_params <- tibble::tibble(cost = 1, rbf_sigma = 0.01)

final_svm <- finalize_workflow(svm_wf, best_params)
```

- Results
```{r}
#| echo: true
#| code-fold: true
#| code-summary: "code"

svm_final_fit <- last_fit(final_svm, split)

collect_metrics(svm_final_fit)

svm_final_fit |> 
  collect_predictions() |> 
  conf_mat(truth = death, estimate = .pred_class)
```
:::

# Model interpretability

## -----Shapley values
```{r}
#| echo: true
#| code-fold: true
#| code-summary: "code"

```

## -----LIME
```{r}
#| echo: true
#| code-fold: true
#| code-summary: "code"

```





